name: Build and Deploy Service

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
        description: 'Service name (e.g., frontend, auth-server)'
      service_path:
        required: true
        type: string
        description: 'Path to service directory (e.g., Frontend, Backend/auth-server)'
      docker_image:
        required: true
        type: string
        description: 'Docker image name (e.g., kkaebu/tickget-frontend)'
      environment:
        required: true
        type: string
        description: 'Environment (dev or prod)'
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      GH_PAT:
        required: true
        description: 'GitHub Personal Access Token for k8s-manifest repo'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine image tag
        id: tag
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [ "${{ inputs.environment }}" = "dev" ]; then
            IMAGE_TAG="dev-${SHORT_SHA}"
          else
            IMAGE_TAG="prod-${SHORT_SHA}"
          fi
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.service_path }}
          platforms: linux/arm64
          push: true
          tags: ${{ inputs.docker_image }}:${{ steps.tag.outputs.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Kubernetes manifest
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          IMAGE_TAG: ${{ steps.tag.outputs.IMAGE_TAG }}
          SHORT_SHA: ${{ steps.tag.outputs.SHORT_SHA }}
        run: |
          # Git configuration
          git config --global user.email "github-actions@tickget.kr"
          git config --global user.name "GitHub Actions"

          # Determine branch name
          if [ "${{ github.ref_name }}" = "main" ]; then
            BRANCH="master"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          # Clone k8s-manifest repository
          git clone --depth 1 --branch $BRANCH \
            https://x-access-token:${GH_PAT}@github.com/Tickget/tickget-k8s-manifest.git k8s-manifest

          cd k8s-manifest

          # Kustomization file path
          KUSTOMIZATION_FILE="apps/${{ inputs.service_name }}/overlays/${{ inputs.environment }}/kustomization.yaml"

          if [ ! -f "$KUSTOMIZATION_FILE" ]; then
            echo "‚ùå Kustomization file not found: $KUSTOMIZATION_FILE"
            exit 1
          fi

          # Update image tag using sed (compatible approach)
          sed -i "s/newTag:.*/newTag: $IMAGE_TAG/" $KUSTOMIZATION_FILE

          # Commit and push changes
          git add $KUSTOMIZATION_FILE
          git commit -m "[CI] Update ${{ inputs.service_name }} image tag to $IMAGE_TAG (commit: ${SHORT_SHA})" || {
            echo "No changes to commit"
            exit 0
          }
          git push origin $BRANCH

      - name: Summary
        run: |
          echo "‚úÖ Successfully built and deployed ${{ inputs.service_name }}"
          echo "üì¶ Image: ${{ inputs.docker_image }}:${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "üåç Environment: ${{ inputs.environment }}"
          echo "üìù Commit: ${{ steps.tag.outputs.SHORT_SHA }}"
