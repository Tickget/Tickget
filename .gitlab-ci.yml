# S13P31A209/.gitlab-ci.yml
stages:
  - build
  - update-manifest

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false" # CI 환경에서 Gradle 데몬 비활성화
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle-cache" # 캐시 경로를 프로젝트 디렉터리 내부로 지정

# --- 1. Gradle 캐시 설정 ---
cache:
  key:
    files:
      # build.gradle 파일이 변경될 때만 캐시를 새로 만듦
      - Backend/test-server/build.gradle
      - Backend/ticketing-server/build.gradle
      - Backend/room-server/build.gradle
  paths:
    # Gradle 라이브러리 및 래퍼 캐싱 (빌드 시간 단축)
    - "$CI_PROJECT_DIR/.gradle-cache/caches/"
    - "$CI_PROJECT_DIR/.gradle-cache/wrapper/"

# --- 2. 공통 Docker 빌드 템플릿 ---
.docker-build-template: &docker-build
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    # Docker Hub 로그인 (GitLab CI 변수 사용)
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker context create buildx-context || true # 이미 존재하면 에러 무시
    - docker buildx create --context buildx-context --use
  script:
    - |
      # $SERVER_NAME: $CI_COMMIT_BRANCH-latest (예: test-server:dev-latest)
      # $SERVER_NAME: $CI_COMMIT_SHORT_SHA (예: test-server:a1b2c3d4)
      # CPU 타입에 맞게 빌드(EC2가 arm64임)
      docker buildx build \
        --platform linux/arm64 \
        -t kkaebu/$SERVER_NAME:$CI_COMMIT_BRANCH-latest \
        -t kkaebu/$SERVER_NAME:$CI_COMMIT_SHORT_SHA \
        $SERVER_PATH \
        --push

# --- 3. 공통 Manifest 업데이트 템플릿 (Kustomize 사용) ---
.kustomize-update-template: &kustomize-update
  stage: update-manifest
  image:
    name: alpine/k8s:1.29.0 # Kustomize가 포함된 이미지
    entrypoint: [""]
  before_script:
    - apk add git
    - git config --global user.name "GitLab CI ($CI_PROJECT_PATH)"
    - git config --global user.email "gitlab-ci@example.com"
    # Manifest 레포를 해당 브랜치로 클론
    - git clone --branch $CI_COMMIT_BRANCH "https://oauth2:${GITLAB_ACCESS_TOKEN}@lab.ssafy.com/h2sorginal/tickget-k8s-manifests.git"
    - cd tickget-k8s-manifests
  script:
    # Kustomize로 이미지 태그 변경
    - cd $KUSTOMIZE_PATH
    - kustomize edit set image kkaebu/$SERVER_NAME=kkaebu/$SERVER_NAME:$CI_COMMIT_SHORT_SHA
    - cd - # 루트 디렉토리로 복귀
    # 변경사항 커밋 및 푸시
    - git commit -am "CI: Update $SERVER_NAME ($CI_COMMIT_BRANCH) to $CI_COMMIT_SHORT_SHA"
    - git push
  
# --- 4. 환경/서버별 작업 정의 ---
# 
# ============ test-server (tst) ============
#
build:test-server:test-dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "test-server"
    SERVER_PATH: "./Backend/test-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      changes: [ "Backend/test-server/**/*" ]

update:test-server:test-dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "test-server"
    KUSTOMIZE_PATH: "apps/test-server/overlays/test"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      needs: ["build:test-server:test-dev"]

build:test-server:dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "test-server"
    SERVER_PATH: "./Backend/test-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [ "Backend/test-server/**/*" ]

update:test-server:dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "test-server"
    KUSTOMIZE_PATH: "apps/test-server/overlays/dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      needs: ["build:test-server:dev"]

build:test-server:master:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "test-server"
    SERVER_PATH: "./Backend/test-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [ "Backend/test-server/**/*" ]

update:test-server:master:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "test-server"
    KUSTOMIZE_PATH: "apps/test-server/overlays/prod" # master 브랜치는 prod 오버레이
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      needs: ["build:test-server:master"]

# 
# ============ ticketing-server (tkt) ============
#
build:ticketing-server:test-dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "ticketing-server"
    SERVER_PATH: "./Backend/ticketing-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      changes: [ "Backend/ticketing-server/**/*" ]

update:ticketing-server:test-dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "ticketing-server"
    KUSTOMIZE_PATH: "apps/ticketing-server/overlays/test"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      needs: ["build:ticketing-server:test-dev"]

build:ticketing-server:dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "ticketing-server"
    SERVER_PATH: "./Backend/ticketing-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [ "Backend/ticketing-server/**/*" ]

update:ticketing-server:dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "ticketing-server"
    KUSTOMIZE_PATH: "apps/ticketing-server/overlays/dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      needs: ["build:ticketing-server:dev"]

build:ticketing-server:master:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "ticketing-server"
    SERVER_PATH: "./Backend/ticketing-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [ "Backend/ticketing-server/**/*" ]

update:ticketing-server:master:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "ticketing-server"
    KUSTOMIZE_PATH: "apps/ticketing-server/overlays/prod" # master 브랜치는 prod 오버레이
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      needs: ["build:ticketing-server:master"]

# 
# ============ room-server (rms) ============
# (room-server도 위와 동일하게 test-dev, dev, master용 build/update 작업을 추가하면 됩니다.)
#