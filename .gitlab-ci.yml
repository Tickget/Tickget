# S13P31A209/.gitlab-ci.yml
stages:
  - build
  - update-manifest

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false" # CI 환경에서 Gradle 데몬 비활성화
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle-cache" # 캐시 경로를 프로젝트 디렉터리 내부로 지정.

# --- 1. 공통 Docker 빌드 템플릿 ---
.docker-build-template: &docker-build
  stage: build
  image: docker:latest
  services:
    - docker:dind
  cache:
    key:
      files:
        - $SERVER_PATH/build.gradle # ★ 각 작업의 SERVER_PATH 변수에 맞는 build.gradle을 사용
      prefix: $CI_COMMIT_REF_SLUG # 브랜치별로 캐시 분리
    paths:
      - "$CI_PROJECT_DIR/.gradle-cache/caches/"
      - "$CI_PROJECT_DIR/.gradle-cache/wrapper/"
    policy: pull-push # 파이프라인 시작 시 캐시를 받고, 완료 시 캐시를 업로드
  before_script:
    # Docker Hub 로그인 (GitLab CI 변수 사용)
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker context create buildx-context || true # 이미 존재하면 에러 무시
    - docker buildx create --context buildx-context --use
  script:
    - |
      # $SERVER_NAME: $CI_COMMIT_BRANCH-latest (예: test-server:dev-latest)
      # $SERVER_NAME: $CI_COMMIT_SHORT_SHA (예: test-server:a1b2c3d4)
      # CPU 타입에 맞게 빌드(EC2가 arm64임)
      docker buildx build \
        --platform linux/arm64 \
        -t kkaebu/$SERVER_NAME:$CI_COMMIT_BRANCH-latest \
        -t kkaebu/$SERVER_NAME:$CI_COMMIT_SHORT_SHA \
        $SERVER_PATH \
        --push

# --- 2. 공통 Manifest 업데이트 템플릿 (Kustomize 사용) ---
.kustomize-update-template: &kustomize-update
  stage: update-manifest
  image:
    name: alpine/k8s:1.29.0 # Kustomize가 포함된 이미지
    entrypoint: [""]
  before_script:
    - apk add git
    - git config --global user.name "GitLab CI ($CI_PROJECT_PATH)"
    - git config --global user.email "gitlab-ci@example.com"
    # Manifest 레포를 해당 브랜치로 클론
    - git clone --branch $CI_COMMIT_BRANCH "https://oauth2:${GITLAB_ACCESS_TOKEN}@lab.ssafy.com/h2sorginal/tickget-k8s-manifests.git"
    - cd tickget-k8s-manifests
  script:
    # Kustomize로 이미지 태그 변경
    - cd $KUSTOMIZE_PATH
    - kustomize edit set image kkaebu/$SERVER_NAME=kkaebu/$SERVER_NAME:$CI_COMMIT_SHORT_SHA
    # - cd - # 루트 디렉토리로 복귀
    # 변경사항 커밋 및 푸시
    - git commit -am "CI: Update $SERVER_NAME ($CI_COMMIT_BRANCH) to $CI_COMMIT_SHORT_SHA"
    - git push
  
# --- 3. 환경/서버별 작업 정의 ---
# 
# ============ test-server (tst) -> test-dev 브랜치 전용 ============
#
build:test-server:test-dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "test-server"
    SERVER_PATH: "./Backend/test-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      changes: [ "Backend/test-server/**/*" ]

update:test-server:test-dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "test-server"
    KUSTOMIZE_PATH: "apps/test-server/overlays/test"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test-dev"'
      needs: ["build:test-server:test-dev"]

# 
# ============ ticketing-server (tkt) -> dev, master 브랜치 전용 ============
#
build:ticketing-server:dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "ticketing-server"
    SERVER_PATH: "./Backend/ticketing-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [ "Backend/ticketing-server/**/*" ]

update:ticketing-server:dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "ticketing-server"
    KUSTOMIZE_PATH: "apps/ticketing-server/overlays/dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      needs: ["build:ticketing-server:dev"]

build:ticketing-server:master:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "ticketing-server"
    SERVER_PATH: "./Backend/ticketing-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [ "Backend/ticketing-server/**/*" ]

update:ticketing-server:master:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "ticketing-server"
    KUSTOMIZE_PATH: "apps/ticketing-server/overlays/prod"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      needs: ["build:ticketing-server:master"]

# 
# ============ room-server (rms) -> dev, master 브랜치 전용 ============
#
build:room-server:dev:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "room-server"
    SERVER_PATH: "./Backend/room-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes: [ "Backend/room-server/**/*" ]

update:room-server:dev:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "room-server"
    KUSTOMIZE_PATH: "apps/room-server/overlays/dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      needs: ["build:room-server:dev"]

build:room-server:master:
  extends: .docker-build-template
  variables:
    SERVER_NAME: "room-server"
    SERVER_PATH: "./Backend/room-server"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes: [ "Backend/room-server/**/*" ]

update:room-server:master:
  extends: .kustomize-update-template
  variables:
    SERVER_NAME: "room-server"
    KUSTOMIZE_PATH: "apps/room-server/overlays/prod"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      needs: ["build:room-server:master"]